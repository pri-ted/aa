.PHONY: help
help: ## Show this help message
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "  AtomicAds Campaign Lifecycle Platform - Infrastructure"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'
	@echo ""

# ============================================================================
# LOCAL DEVELOPMENT TARGETS
# ============================================================================

.PHONY: quickstart-local
quickstart-local: ## üöÄ ONE-COMMAND LOCAL DEPLOYMENT - Complete platform on local K8s
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "üöÄ AtomicAds Platform - Local Quickstart"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo ""
	@$(MAKE) preflight-local
	@$(MAKE) setup-local-cluster
	@$(MAKE) bootstrap-argocd
	@$(MAKE) deploy-platform-local
	@$(MAKE) verify-platform
	@$(MAKE) show-endpoints
	@echo ""
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "‚úÖ Platform Ready!"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

.PHONY: preflight-local
preflight-local: ## ‚úì Verify prerequisites for local deployment
	@echo "‚Üí Checking prerequisites..."
	@command -v docker >/dev/null 2>&1 || (echo "‚ùå Docker not found. Install Docker Desktop" && exit 1)
	@command -v kubectl >/dev/null 2>&1 || (echo "‚ùå kubectl not found. Run: brew install kubectl" && exit 1)
	@command -v kustomize >/dev/null 2>&1 || (echo "‚ùå kustomize not found. Run: brew install kustomize" && exit 1)
	@command -v helm >/dev/null 2>&1 || (echo "‚ùå helm not found. Run: brew install helm" && exit 1)
	@docker info >/dev/null 2>&1 || (echo "‚ùå Docker daemon not running. Start Docker Desktop" && exit 1)
	@kubectl cluster-info >/dev/null 2>&1 || (echo "‚ùå Kubernetes cluster not accessible. Enable Kubernetes in Docker Desktop" && exit 1)
	@if [ -z "$$GITHUB_TOKEN" ]; then echo "‚ö†Ô∏è  WARNING: GITHUB_TOKEN not set. ArgoCD may fail to sync private repos."; fi
	@echo "‚úÖ All prerequisites met"

.PHONY: setup-local-cluster
setup-local-cluster: ## üèóÔ∏è  Configure local Kubernetes cluster
	@echo "‚Üí Setting up local Kubernetes cluster..."
	@kubectl config use-context docker-desktop || kubectl config use-context k3s-default || (echo "‚ùå No local cluster found" && exit 1)
	@kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
	@kubectl create namespace atomicads-local --dry-run=client -o yaml | kubectl apply -f -
	@echo "‚úÖ Local cluster configured"

.PHONY: bootstrap-argocd
bootstrap-argocd: ## üì¶ Install and configure ArgoCD
	@echo "‚Üí Installing ArgoCD..."
	@./scripts/bootstrap-argocd.sh
	@echo "‚úÖ ArgoCD installed and configured"

.PHONY: deploy-platform-local
deploy-platform-local: ## üö¢ Deploy all platform components via ArgoCD
	@echo "‚Üí Deploying platform components..."
	@kubectl apply -k ../platform-kubernetes/overlays/local/ 2>/dev/null || echo "‚ö†Ô∏è  Local overlay not found, will create it"
	@echo "‚úÖ Platform deployment initiated"

.PHONY: verify-platform
verify-platform: ## üîç Verify all components are healthy
	@echo "‚Üí Verifying platform health..."
	@./scripts/verify-platform.sh

.PHONY: show-endpoints
show-endpoints: ## üìç Display service access endpoints
	@echo ""
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "üìç Service Endpoints"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo ""
	@./scripts/show-endpoints.sh

.PHONY: logs-local
logs-local: ## üìã Stream logs from all platform components
	@echo "‚Üí Streaming platform logs (Ctrl+C to stop)..."
	@kubectl logs -f -l app.kubernetes.io/part-of=atomicads -n atomicads-local --all-containers=true --max-log-requests=10 2>/dev/null || \
		kubectl logs -f -l platform=atomicads -n atomicads-local --all-containers=true --max-log-requests=10

.PHONY: teardown-local
teardown-local: ## üóëÔ∏è  Complete cleanup of local environment
	@echo "‚ö†Ô∏è  This will DELETE all local platform resources!"
	@read -p "Continue? (yes/no): " confirm && [ "$$confirm" = "yes" ] || (echo "Aborted" && exit 1)
	@echo "‚Üí Tearing down local environment..."
	@kubectl delete namespace atomicads-local --ignore-not-found=true
	@kubectl delete namespace argocd --ignore-not-found=true
	@echo "‚úÖ Local environment cleaned up"

# ============================================================================
# AWS EKS DEPLOYMENT TARGETS
# ============================================================================

.PHONY: quickstart-aws-dev
quickstart-aws-dev: ## üå©Ô∏è  Deploy to AWS EKS (dev environment)
	@echo "‚Üí Deploying to AWS EKS (dev)..."
	@cd terraform/providers/aws/dev && terraform init && terraform apply -auto-approve
	@$(MAKE) configure-kubectl-aws-dev
	@$(MAKE) bootstrap-argocd
	@echo "‚úÖ AWS dev environment ready"

.PHONY: configure-kubectl-aws-dev
configure-kubectl-aws-dev: ## ‚öôÔ∏è  Configure kubectl for AWS EKS dev
	@echo "‚Üí Configuring kubectl for AWS EKS..."
	@aws eks update-kubeconfig --region us-east-1 --name platform-dev

.PHONY: terraform-plan-dev
terraform-plan-dev: ## üìã Show Terraform plan for dev
	@cd terraform/providers/aws/dev && terraform plan

.PHONY: terraform-apply-dev
terraform-apply-dev: ## üöÄ Apply Terraform for dev
	@cd terraform/providers/aws/dev && terraform apply

.PHONY: terraform-destroy-dev
terraform-destroy-dev: ## üí• Destroy AWS dev infrastructure
	@echo "‚ö†Ô∏è  This will DESTROY the AWS dev environment!"
	@read -p "Type 'destroy' to confirm: " confirm && [ "$$confirm" = "destroy" ] || exit 1
	@cd terraform/providers/aws/dev && terraform destroy

# ============================================================================
# ARGOCD MANAGEMENT
# ============================================================================

.PHONY: argocd-ui
argocd-ui: ## üåê Open ArgoCD UI in browser
	@echo "‚Üí Opening ArgoCD UI..."
	@echo "Username: admin"
	@echo "Password: $$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)"
	@kubectl port-forward svc/argocd-server -n argocd 8080:443 >/dev/null 2>&1 &
	@sleep 2
	@open https://localhost:8080 || echo "Open https://localhost:8080 in your browser"

.PHONY: argocd-password
argocd-password: ## üîë Get ArgoCD admin password
	@echo "ArgoCD Admin Password:"
	@kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
	@echo ""

.PHONY: argocd-sync-all
argocd-sync-all: ## üîÑ Sync all ArgoCD applications
	@echo "‚Üí Syncing all applications..."
	@kubectl get applications -n argocd -o name | xargs -I {} kubectl patch {} -n argocd --type merge -p '{"operation":{"sync":{}}}'
	@echo "‚úÖ Sync triggered for all applications"

# ============================================================================
# DATABASE MANAGEMENT
# ============================================================================

.PHONY: db-migrate
db-migrate: ## üì¶ Run database migrations
	@echo "‚Üí Running database migrations..."
	@kubectl exec -n atomicads-local -it deployment/postgres -- psql -U platform -d platform_dev -f /migrations/001_init_schema.sql
	@echo "‚úÖ Migrations complete"

.PHONY: db-seed
db-seed: ## üå± Load seed data
	@echo "‚Üí Loading seed data..."
	@kubectl exec -n atomicads-local -it deployment/postgres -- psql -U platform -d platform_dev -f /migrations/002_seed_data.sql
	@echo "‚úÖ Seed data loaded"

.PHONY: db-reset
db-reset: ## üîÑ Reset database (drop and recreate)
	@echo "‚ö†Ô∏è  This will DELETE all data!"
	@read -p "Continue? (yes/no): " confirm && [ "$$confirm" = "yes" ] || exit 1
	@kubectl exec -n atomicads-local -it deployment/postgres -- psql -U platform -d postgres -c "DROP DATABASE IF EXISTS platform_dev;"
	@kubectl exec -n atomicads-local -it deployment/postgres -- psql -U platform -d postgres -c "CREATE DATABASE platform_dev;"
	@$(MAKE) db-migrate
	@$(MAKE) db-seed
	@echo "‚úÖ Database reset complete"

.PHONY: db-shell-postgres
db-shell-postgres: ## üêò Connect to PostgreSQL shell
	@kubectl exec -n atomicads-local -it deployment/postgres -- psql -U platform -d platform_dev

.PHONY: db-shell-clickhouse
db-shell-clickhouse: ## üè† Connect to ClickHouse shell
	@kubectl exec -n atomicads-local -it deployment/clickhouse -- clickhouse-client

.PHONY: db-shell-redis
db-shell-redis: ## üî¥ Connect to Redis shell
	@kubectl exec -n atomicads-local -it deployment/redis -- redis-cli

# ============================================================================
# MONITORING & DEBUGGING
# ============================================================================

.PHONY: status
status: ## üìä Show platform status
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "Platform Status"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo ""
	@echo "‚Üí Namespaces:"
	@kubectl get namespaces | grep -E "NAME|atomicads|argocd"
	@echo ""
	@echo "‚Üí Pods (atomicads-local):"
	@kubectl get pods -n atomicads-local
	@echo ""
	@echo "‚Üí Services:"
	@kubectl get svc -n atomicads-local
	@echo ""
	@echo "‚Üí ArgoCD Applications:"
	@kubectl get applications -n argocd 2>/dev/null || echo "ArgoCD not installed"

.PHONY: grafana
grafana: ## üìä Open Grafana dashboards
	@echo "‚Üí Opening Grafana..."
	@kubectl port-forward -n atomicads-local svc/grafana 3000:80 >/dev/null 2>&1 &
	@sleep 2
	@echo "Grafana: http://localhost:3000 (admin/admin)"
	@open http://localhost:3000 || echo "Open http://localhost:3000 in your browser"

.PHONY: prometheus
prometheus: ## üìà Open Prometheus UI
	@echo "‚Üí Opening Prometheus..."
	@kubectl port-forward -n atomicads-local svc/prometheus 9090:9090 >/dev/null 2>&1 &
	@sleep 2
	@open http://localhost:9090 || echo "Open http://localhost:9090 in your browser"

# ============================================================================
# UTILITY TARGETS
# ============================================================================

.PHONY: k9s
k9s: ## üêï Launch k9s (Kubernetes CLI UI)
	@command -v k9s >/dev/null 2>&1 || (echo "Install k9s: brew install k9s" && exit 1)
	@k9s -n atomicads-local

.PHONY: clean-pv
clean-pv: ## üßπ Clean persistent volumes
	@kubectl delete pvc --all -n atomicads-local
	@kubectl delete pv --all

.PHONY: restart-pod
restart-pod: ## üîÑ Restart a specific pod (Usage: make restart-pod POD=postgres)
	@if [ -z "$(POD)" ]; then echo "Usage: make restart-pod POD=<pod-name>"; exit 1; fi
	@kubectl delete pod -n atomicads-local -l app=$(POD)
	@echo "‚úÖ Pod $(POD) restarted"

.PHONY: describe-pod
describe-pod: ## üîç Describe a specific pod (Usage: make describe-pod POD=postgres)
	@if [ -z "$(POD)" ]; then echo "Usage: make describe-pod POD=<pod-name>"; exit 1; fi
	@kubectl describe pod -n atomicads-local -l app=$(POD)

.PHONY: port-forward
port-forward: ## üîå Port forward to a service (Usage: make port-forward SVC=postgres PORT=5432)
	@if [ -z "$(SVC)" ] || [ -z "$(PORT)" ]; then echo "Usage: make port-forward SVC=<service> PORT=<port>"; exit 1; fi
	@kubectl port-forward -n atomicads-local svc/$(SVC) $(PORT):$(PORT)

# ============================================================================
# DEFAULT TARGET
# ============================================================================

.DEFAULT_GOAL := help
